generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
}

enum UserStatus {
  active
  suspended
  deleted
}

enum WorkLogStatus {
  in_progress
  completed
  on_hold
}

enum ConflictStatus {
  pending
  resolved
}

enum SyncType {
  upload
  download
  conflict
}

enum SyncStatus {
  success
  failed
  pending
}

enum DeviceType {
  mobile
  tablet
  desktop
}

enum AnnouncementType {
  info
  warning
  maintenance
}

enum ReportStatus {
  pending
  in_progress
  resolved
  rejected
}

model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  encryptedPassword String    @map("encrypted_password")
  name              String?
  avatarUrl         String?   @map("avatar_url")
  role              UserRole  @default(user)
  status            UserStatus @default(active)
  lastLoginAt       DateTime? @map("last_login_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  workLogs           WorkLog[]
  categories         Category[]
  tags               Tag[]
  statistics         Statistics[]
  syncLogs           SyncLog[]
  devices            Device[]
  announcementReads  AnnouncementRead[]
  reportedBy         Report[] @relation("ReportedBy")
  resolvedReports    Report[] @relation("ResolvedBy")
  goals              UserGoal[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model WorkLog {
  id              Int             @id @default(autoincrement())
  userId          Int             @map("user_id")
  title           String
  content         String?         @db.Text
  workDate        DateTime        @map("work_date") @db.Date
  durationMinutes Int             @default(0) @map("duration_minutes")
  status          WorkLogStatus   @default(in_progress)
  published       Boolean         @default(false)
  localId         String?         @map("local_id") @db.VarChar(36)
  synced          Boolean         @default(false)
  lastSyncedAt    DateTime?       @map("last_synced_at")
  conflictStatus  ConflictStatus? @map("conflict_status")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories  WorkLogCategory[]
  tags        WorkLogTag[]
  attachments Attachment[]
  syncLogs    SyncLog[]
  reports     Report[]

  @@index([userId, workDate])
  @@index([status])
  @@index([published])
  @@index([localId])
  @@index([synced])
  @@map("work_logs")
}

model Category {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String   @db.VarChar(100)
  color     String   @default("#3B82F6") @db.VarChar(7)
  icon      String?  @db.VarChar(50)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLogs WorkLogCategory[]

  @@index([sortOrder])
  @@map("categories")
}

model Tag {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLogs WorkLogTag[]

  @@unique([userId, name])
  @@map("tags")
}

model WorkLogCategory {
  id         Int      @id @default(autoincrement())
  workLogId  Int      @map("work_log_id")
  categoryId Int      @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  workLog  WorkLog  @relation(fields: [workLogId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([workLogId, categoryId])
  @@map("work_log_categories")
}

model WorkLogTag {
  id        Int      @id @default(autoincrement())
  workLogId Int      @map("work_log_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  workLog WorkLog @relation(fields: [workLogId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([workLogId, tagId])
  @@map("work_log_tags")
}

model Attachment {
  id        Int      @id @default(autoincrement())
  workLogId Int      @map("work_log_id")
  fileName  String   @map("file_name")
  fileType  String?  @map("file_type") @db.VarChar(100)
  fileSize  BigInt?  @map("file_size")
  fileUrl   String?  @map("file_url") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")

  workLog WorkLog @relation(fields: [workLogId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Statistics {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  statDate     DateTime @map("stat_date") @db.Date
  totalMinutes Int      @default(0) @map("total_minutes")
  workCount    Int      @default(0) @map("work_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, statDate])
  @@map("statistics")
}

model SyncLog {
  id           Int        @id @default(autoincrement())
  userId       Int        @map("user_id")
  workLogId    Int?       @map("work_log_id")
  syncType     SyncType   @map("sync_type")
  status       SyncStatus
  errorMessage String?    @map("error_message") @db.Text
  syncedAt     DateTime   @default(now()) @map("synced_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLog WorkLog? @relation(fields: [workLogId], references: [id], onDelete: Cascade)

  @@index([userId, syncedAt])
  @@index([status])
  @@map("sync_logs")
}

model Device {
  id         Int         @id @default(autoincrement())
  userId     Int         @map("user_id")
  deviceName String?     @map("device_name")
  deviceType DeviceType? @map("device_type")
  lastSyncAt DateTime?   @map("last_sync_at")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("devices")
}

model Announcement {
  id               Int              @id @default(autoincrement())
  title            String
  content          String           @db.Text
  announcementType AnnouncementType @default(info) @map("announcement_type")
  published        Boolean          @default(false)
  publishedAt      DateTime?        @map("published_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  reads AnnouncementRead[]

  @@index([published, publishedAt])
  @@map("announcements")
}

model AnnouncementRead {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  announcementId Int      @map("announcement_id")
  readAt         DateTime @default(now()) @map("read_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([userId, announcementId])
  @@map("announcement_reads")
}

model Report {
  id                Int          @id @default(autoincrement())
  reporterUserId    Int          @map("reporter_user_id")
  reportedWorkLogId Int?         @map("reported_work_log_id")
  reason            String       @db.Text
  status            ReportStatus @default(pending)
  adminNote         String?      @map("admin_note") @db.Text
  resolvedByUserId  Int?         @map("resolved_by_user_id")
  resolvedAt        DateTime?    @map("resolved_at")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  reporter       User     @relation("ReportedBy", fields: [reporterUserId], references: [id], onDelete: Cascade)
  reportedWorkLog WorkLog? @relation(fields: [reportedWorkLogId], references: [id], onDelete: Cascade)
  resolvedBy     User?    @relation("ResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

model UserGoal {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  goalType    String   @map("goal_type") @db.VarChar(50)
  targetValue Int      @map("target_value")
  year        Int?
  month       Int?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, goalType])
  @@map("user_goals")
}
